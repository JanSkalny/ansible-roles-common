Client {
  Name = {{backup_client}}
  Address = {{backup_address}}
  FDPort = {{backup_port|default(9102)}}
  Catalog = MyCatalog
  Password = "{{hostvars[backup_client]['backup_password']}}"
  AutoPrune = yes

  TLS Enable = yes
  TLS Require = yes
  TLS CA Certificate File = /etc/bacula/ssl/ca.crt
  TLS Certificate = /etc/bacula/ssl/{{backup_director}}.crt
  TLS Key = /etc/bacula/ssl/{{backup_director}}.pem
}

Job {
  Name = {{backup_client}}
  Client = {{backup_client}}
  FileSet = {{backup_client}}

  Full Backup Pool = {{backup_client}}-full
  Incremental Backup Pool = {{backup_client}}-inc
  Differential Backup Pool = {{backup_client}}-diff

{% if hostvars[backup_client]['backup_sql_password'] is defined %}
  ClientRunBeforeJob = "/etc/bacula/scripts/make_mysql_backup.sh %l"
{% endif %}
{% if hostvars[backup_client]['backup_gitlab_dir'] is defined %}
  ClientRunBeforeJob = "/etc/bacula/scripts/make_gitlab_backup.sh %l"
{% endif %}


  JobDefs = "DefaultJob"
}

FileSet {
  Name = "{{backup_client}}"
  Include {
    Options {
      signature = MD5
      compression = gzip
    }
    File = /etc
    File = /home
    File = /root
    File = /var/backups
    File = /var/www
{% for backup_dir in backup_include %}
    File = {{backup_dir}}
{% endfor %}
  }

  Exclude {
    File = /proc
    File = /tmp
    File = /.journal
    File = /.fsck
	File = /var/run
	File = /run
	File = /sys
{% for backup_dir in backup_exclude %}
    File = {{backup_dir}}
{% endfor %}
  }
}

Pool {
  Name = {{backup_client}}-full
  Label Format = "{{backup_client}}-full-"
  Pool Type = Backup

  Recycle = yes
  AutoPrune = yes
  Action On Purge = Truncate

  Volume Retention = 40 days
  Maximum Volume Jobs = 1
  Maximum Volumes = 2
}

Pool {
  Name = {{backup_client}}-inc
  Label Format = "{{backup_client}}-inc-"
  Pool Type = Backup

  Recycle = yes
  AutoPrune = yes
  Action On Purge = Truncate

  Volume Retention = 10 days
  Maximum Volume Jobs = 1
  Maximum Volumes = 20
}

Pool {
  Name = {{backup_client}}-diff
  Label Format = "{{backup_client}}-diff-"
  Pool Type = Backup

  Recycle = yes
  AutoPrune = yes
  Action On Purge = Truncate

  Volume Retention = 35 days
  Maximum Volume Jobs = 1
  Maximum Volumes = 6
}

